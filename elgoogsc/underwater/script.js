let imagePath="img/";let b2BuoyancyController=Box2D.Dynamics.Controllers.b2BuoyancyController;let b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;let b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;let b2Vec2=Box2D.Common.Math.b2Vec2;let b2BodyDef=Box2D.Dynamics.b2BodyDef;let b2ContactListener=Box2D.Dynamics.b2ContactListener;let b2DebugDraw=Box2D.Dynamics.b2DebugDraw;let b2FilterData=Box2D.Dynamics.b2FilterData;let b2FixtureDef=Box2D.Dynamics.b2FixtureDef;let b2World=Box2D.Dynamics.b2World;let b2Body=Box2D.Dynamics.b2Body;let WIDTH=window.innerWidth;let HEIGHT=window.innerHeight;let resourceTool,gImageSearch,bc,context;let RATIO=30;let world=null;let bodies=[];let timer=[];let isImpact=false;let nowTime=new Date;let waterLevel=HEIGHT*0.4;waterLevel=waterLevel>HEIGHT-260?HEIGHT-260:waterLevel;waterLevel=waterLevel<120?120:waterLevel;let searchResults=[{"GsearchResultClass":"GimageSearch","width":"217","height":"90","imageId":"","tbWidth":"217","tbHeight":"90","unescapedUrl":"shark.png","url":"shark.png","visibleUrl":"shark.png","title":"shark","titleNoFormatting":"shark","originalContextUrl":"","content":"","contentNoFormatting":"","tbUrl":"shark.png","target":"_blank","html":{}},{"GsearchResultClass":"GimageSearch","width":"320","height":"82","imageId":"","tbWidth":"320","tbHeight":"82","unescapedUrl":"fish1.png","url":"fish1.png","visibleUrl":"fish1.png","title":"fish icon 2","titleNoFormatting":"fish icon 2","originalContextUrl":"","content":"","contentNoFormatting":"","tbUrl":"fish1.png","target":"_blank","html":{}},{"GsearchResultClass":"GimageSearch","width":"166","height":"68","imageId":"","tbWidth":"166","tbHeight":"68","unescapedUrl":"fish2.png","url":"fish2.png","visibleUrl":"fish2.png","title":"fish icon 3","titleNoFormatting":"fish icon 3","originalContextUrl":"","content":"","contentNoFormatting":"","tbUrl":"fish2.png","target":"_blank","html":{}},{"GsearchResultClass":"GimageSearch","width":"192","height":"96","imageId":"","tbWidth":"192","tbHeight":"96","unescapedUrl":"fish3.png","url":"fish3.png","visibleUrl":"fish3.png","title":"fish icon 4","titleNoFormatting":"fish icon 4","originalContextUrl":"","content":"","contentNoFormatting":"","tbUrl":"fish3.png","target":"_blank","html":{}}]
$(function(){resourceTool=new ResourceTool;let progressFunc=function(e,percentage){$("#loading").css("width",percentage*100+"%")};$(resourceTool).bind(ResourceEvent.PROGRESS,progressFunc);$(resourceTool).bind(ResourceEvent.COMPLETED,function(){$(resourceTool).unbind(ResourceEvent.PROGRESS,progressFunc);$(resourceTool).unbind(ResourceEvent.COMPLETED,arguments.callee);$("#loadingAnim").remove();$("#loading").remove();$(".menu-button").css("display","block");$(".nav-arrow").css("display","block");$("#tr_slot1x1").css("display","block");if(window.screen.width<=768){$("#tr_slot468").css("display","block");}
$("#wrapper").css("display","block");$("input[name=btnK]").bind("click",function(){let fishNo=Math.floor(Math.random()*4);let data=searchResults[fishNo];let img=new Image();$(img).bind("load",function(){$(this).unbind("load",arguments.callee);switch(fishNo){case 0:new Box2dModel(WIDTH-Math.random()*200,waterLevel+gap,213,40,1.6,resourceTool.content["shark"],true,true,1,true);break;case 1:new Box2dModel(WIDTH/2-Math.random()*100,waterLevel+gap*2,320,82,1.6,resourceTool.content["fish1"],true,true);break;case 2:new Box2dModel(WIDTH/2+Math.random()*200,waterLevel+gap*3,166,68,1.6,resourceTool.content["fish2"],true,true,-1);break;case 3:new Box2dModel(Math.random()*100,waterLevel+gap*4,192,96,1.6,resourceTool.content["fish3"],true,true,-1);break;}});img.src=imagePath+data.tbUrl;});$("input[name=btnI]").bind("click",function(){let ran=Math.random();if(ran<0.03)new Box2dModel(100+Math.random()*(WIDTH-100),0,100,76,10,resourceTool.content["crown"]);if(ran>0.03&&ran<0.08)new Box2dModel(100+Math.random()*(WIDTH-100),0,122,120,15,resourceTool.content["box"]);if(ran>0.08&&ran<0.18)new Box2dModel(100+Math.random()*(WIDTH-100),0,41,85,10,resourceTool.content["bottle"]);let coin=new Box2dModel(100+Math.random()*(WIDTH-100),0,34,50,5,resourceTool.content["coin"]);coin.body.SetAngularVelocity(30)});context=$("#canvas").get(0).getContext("2d");$("#googleLogo").css("left",WIDTH/2-$("#googleLogo").width()/2+"px");let logoLeft=parseInt($("#googleLogo").css("left").substr(0,$("#googleLogo").css("left").indexOf("p")));$("input[name=q]").css("left",WIDTH/2-$("input[name=q]").width()/2+"px");$("input[name=btnK]").css("left",WIDTH/2-112+"px");$("input[name=btnI]").css("left",WIDTH/2+10+"px");$("#canvas").get(0).width=WIDTH;$("#canvas").get(0).height=HEIGHT;let deltaTime=0;let stepTime=1/60;let maxSteps=3;let velocityIterations=10;let positionIterations=10;let lastTime=(new Date).getTime();world=new b2World(new b2Vec2(0,0),true);world.SetGravity(new b2Vec2(0,9.8));bc=new b2BuoyancyController;bc.normal.Set(0,-1);bc.offset=(-waterLevel-15)/RATIO;bc.density=2;bc.linearDrag=12;bc.angularDrag=3;world.AddController(bc);initWave();let lastTwitchTime=(new Date).getTime();let waterStep=HEIGHT/86400;let enterFrame=function(){let now=(new Date).getTime();deltaTime+=(now-lastTime)*0.001;for(let steps=0;deltaTime>=stepTime&&steps<maxSteps;steps++){world.Step(stepTime,velocityIterations,positionIterations);world.ClearForces();world.DrawDebugData();deltaTime-=stepTime;if(now-lastTwitchTime>500&&!isImpact){lastTwitchTime=now;waterLevel-=waterStep;waterLevel=waterLevel<120?120:waterLevel;bc.offset=(-waterLevel-15)/RATIO;let len=particles.length;for(let i=0;i<len;i++){particles[i].y-=waterStep;particles[i].original.y-=waterStep}
bc.velocity=new b2Vec2((Math.random()>0.5?1:-1)*Math.random(),-Math.random());for(let i=0;i<DETAIL;i++)Twitch(i*10,0.5)}
context.clearRect(0,0,WIDTH,HEIGHT);for(let i in timer)timer[i]();drawBitmap(resourceTool.content["seeweed"],100,HEIGHT-257,Math.random()*0.3*Box2dUtils.DEGREE_TO_RADIAN,1);drawBitmap(resourceTool.content["seeweed"],WIDTH-200,HEIGHT-207,Math.random()*0.3*Box2dUtils.DEGREE_TO_RADIAN,0.5);updateWave();context.save();context.translate(WIDTH/2,HEIGHT-89);context.drawImage(resourceTool.content["land-wide"],-3875/2,0);context.restore()}
lastTime=now;setTimeout(enterFrame,33)};enterFrame();let wallThickness=20;let top=new Wall(WIDTH/2,-wallThickness/2,WIDTH,wallThickness);let bottom=new Wall(WIDTH/2,HEIGHT-wallThickness/2,WIDTH,wallThickness);let left=new Wall(-wallThickness/2,HEIGHT/2,wallThickness,HEIGHT);let right=new Wall(WIDTH+wallThickness/2,HEIGHT/2,wallThickness,HEIGHT);generateBodyForElement($("#googleLogo"),1);generateBodyForElement($("input[name=q]"),1.1);generateBodyForElement($("input[name=btnK]"),0.7);generateBodyForElement($("input[name=btnI]"),0.7);let gap=(HEIGHT-waterLevel-150)/4;let shark=new Box2dModel(WIDTH-
Math.random()*200,waterLevel+gap,213,40,1.6,resourceTool.content["shark"],true,true,1,true);let fish1=new Box2dModel(WIDTH/2-Math.random()*100,waterLevel+gap*2,320,82,1.6,resourceTool.content["fish1"],true,true);let fish2=new Box2dModel(WIDTH/2+Math.random()*200,waterLevel+gap*3,166,68,1.6,resourceTool.content["fish2"],true,true,-1);let fish3=new Box2dModel(Math.random()*100,waterLevel+gap*4,192,96,1.6,resourceTool.content["fish3"],true,true,-1);let isFall=false;let generateWave=function(x,y,offset){if(y>waterLevel){Twitch(x,-offset);Twitch(x-10,-offset);Twitch(x+10,-offset);for(let i=0;i<bodies.length;i++){let body=bodies[i];body.body.SetAwake(true);let pos=body.getPosition();let rect=body.getRectangle();if(pos.y>waterLevel&&x>=pos.x-rect.x/2-200&&x<=pos.x+rect.x/2+200&&y>=pos.y-rect.y/2-200&&y<=pos.y+rect.y/2+200){let vecX=x==pos.x?0:x>pos.x?-200:200;body.body.SetLinearVelocity(Box2dUtils.parseB2Vec2(vecX,-100))}}}};let moveFunc=function(e){let pageX;let pageY;switch(e.type){case "touchmove":if(e.originalEvent.touches.length>1)return;pageX=e.originalEvent.changedTouches[0].pageX;pageY=e.originalEvent.changedTouches[0].pageY;break;default:pageX=e.pageX;pageY=e.pageY;break}
generateWave(pageX,pageY,(1-(pageY-waterLevel)/(HEIGHT-waterLevel))*4)};$("#canvas").bind("mousedown touchstart",function(e){let pageX;let pageY;switch(e.type){case "touchstart":if(e.originalEvent.touches.length>1)return;pageX=e.originalEvent.touches[0].pageX;pageY=e.originalEvent.touches[0].pageY;break;default:pageX=e.pageX;pageY=e.pageY;break}
generateWave(pageX,pageY,(1-(pageY-waterLevel)/(HEIGHT-waterLevel))*4);$("#canvas").bind("mousemove touchmove",moveFunc)});$(window).bind("mouseup touchend",function(e){$("#canvas").unbind("mousemove touchmove",moveFunc)}).bind("keyup",function(e){if(e.keyCode==13)$("input[name=btnK]").click()}).bind("resize",function(){world.DestroyBody(top.body);world.DestroyBody(bottom.body);world.DestroyBody(left.body);world.DestroyBody(right.body);WIDTH=window.innerWidth;HEIGHT=window.innerHeight;$("#canvas").get(0).width=WIDTH;$("#canvas").get(0).height=HEIGHT;initWave();top=new Wall(WIDTH/2,-wallThickness/2,WIDTH,wallThickness);bottom=new Wall(WIDTH/2,HEIGHT+wallThickness,WIDTH,wallThickness);left=new Wall(-wallThickness/2,HEIGHT/2,wallThickness,HEIGHT);right=new Wall(WIDTH+wallThickness/2,HEIGHT/2,wallThickness,HEIGHT)});$("input[name=q]").focus(function(){if(!isFall)isFall=true;for(let i=0;i<bodies.length;i++){let body=bodies[i];body.body.SetAwake(true)}})});resourceTool.load(["shark.png","fish1.png","fish2.png","fish3.png","land-wide.png","seeweed.png","bottle.png","coin.png","box.png","crown.png"])});let generateBodyForElement=function(element,density){let offset=element.offset();let width=element.outerWidth()==0?100:element.outerWidth();let height=element.outerHeight()==0?100:element.outerHeight();let rect=new Rect(width,height,element,density);rect.setPosition(new Point(offset.left+width/2,offset.top+height/2));bodies.push(rect);bc.AddBody(rect.body)};let Actor=function(){let bodyDef=new b2BodyDef;return function(){let _self=this;_self.body=world.CreateBody(bodyDef);_self.density=0;_self.friction=0;_self.restitution=0;let _rectangle;_self.getRectangle=function(){return _rectangle};_self.setRectangle=function(value){let fixture=_self.body.GetFixtureList();if(fixture!=null)_self.body.DestroyFixture(fixture);fixture=_self.body.CreateFixture(Box2dUtils.generateRectangleB2FixtureDef(value.x,value.y,_self.density,_self.friction,_self.restitution));_rectangle=value};let _radius=0;_self.getRadius=function(){return _radius};_self.setRadius=function(value){let fixture=_self.body.GetFixtureList();if(fixture!=null)_self.body.DestroyFixture(fixture);fixture=_self.body.CreateFixture(Box2dUtils.generateCircleB2FixtureDef(value,_self.density,_self.friction,_self.restitution));_radius=value};_self.getPosition=function(){return Box2dUtils.parsePoint(_self.body.GetPosition().Copy())};_self.setPosition=function(value){_self.body.SetPosition(Box2dUtils.parseB2Vec2(value.x,value.y))};_self.getAngle=function(){return _self.body.GetAngle()};_self.setAngle=function(value){_self.body.SetAngle(value)}}}();let inherit=function(childClass,parentClass){let tempConstructor=function(){};tempConstructor.prototype=parentClass.prototype;childClass.prototype=new tempConstructor;childClass.prototype.constructor=childClass};let Rect=function(){let _counter=0;return function(width,height,view,density){let _self=this;Actor.apply(_self);_self.body.SetType(b2Body.b2_dynamicBody);_self.density=density;_self.setRectangle(new Point(width,height));_self.body.SetAwake(false);_self.view=view;let range;let _twitched=0;let step=25;let amount=3;timer["Rect"+_counter]=function(){if(_self.getPosition().y>=waterLevel)if(_self.body.IsAwake()){if(range==null)range=Math.abs(_self.body.GetLinearVelocity().y)/10*2;if(_twitched<24){if(_twitched<6)for(let i=-amount+1;i<amount;i++)Twitch(_self.getPosition().x+i*step,range);else if(_twitched<16)for(let i=-amount+1;i<amount;i++)Twitch(_self.getPosition().x+i*step,-range);isImpact=true;_twitched++}else isImpact=false}else{_self.body.SetAwake(true);_twitched=24}else{range=null;_twitched=0}
if(_self.view){_self.view.css("left",_self.getPosition().x-_self.getRectangle().x/2+"px");_self.view.css("top",65+_self.getPosition().y-_self.getRectangle().y/2+"px");_self.view.css("-webkit-transform","rotate("+
_self.getAngle()*Box2dUtils.RADIAN_TO_DEGREE+"deg)");_self.view.css("-o-transform","rotate("+_self.getAngle()*Box2dUtils.RADIAN_TO_DEGREE+"deg)");_self.view.css("-moz-transform","rotate("+_self.getAngle()*Box2dUtils.RADIAN_TO_DEGREE+"deg)");_self.view.css("-ms-transform","rotate("+_self.getAngle()*Box2dUtils.RADIAN_TO_DEGREE+"deg)");_self.view.css("transform","rotate("+_self.getAngle()*Box2dUtils.RADIAN_TO_DEGREE+"deg)")}};_counter++}}();inherit(Rect,Actor);let Wall=function(){return function(x,y,width,height,view){let _self=this;Actor.apply(_self);_self.density=10;_self.friction=0.1;_self.restitution=0.1;_self.body.SetType(b2Body.b2_staticBody);_self.setRectangle(new Point(width,height));_self.setPosition(new Point(x,y))}}();inherit(Wall,Actor);let Box2dModel=function(){let _counter=0;return function(x,y,width,height,density,view,fixed,isSensor,direction,fixDirection){fixed=fixed==null?false:fixed;isSensor=isSensor==null?false:isSensor;direction=direction==null?1:-1;fixDirection=fixDirection==null?false:fixDirection;let _self=this;Actor.apply(_self);_self.id="Box2dModel"+_counter;_counter++;_self.body.SetType(b2Body.b2_dynamicBody);_self.density=density;_self.restitution=0.3;_self.setRectangle(new Point(width,height));_self.setPosition(new Point(x,y));if(fixed)_self.body.SetFixedRotation(true);else _self.setAngle(-Math.PI/4+Math.random()*Math.PI/4);if(isSensor)_self.body.GetFixtureList().SetSensor(true);let posY=y;let range;let _twitched=0;let step=15;let amount=3;let xAngle=Math.round(Math.random()*360);let yAngle=Math.round(Math.random()*360);timer[_self.id]=function(){if(_self.getPosition().y>=waterLevel)if(_self.body.IsAwake()){if(range==null)range=Math.abs(_self.body.GetLinearVelocity().y)/10*0.5;if(_twitched<24){if(_twitched<6)for(let i=-amount+1;i<amount;i++)Twitch(_self.getPosition().x+i*step,range);else if(_twitched<16)for(let i=-amount+1;i<amount;i++)Twitch(_self.getPosition().x+i*step,-range);isImpact=true;_twitched++}else isImpact=false}else{_self.body.SetAwake(true);_twitched=24}else{range=null;_twitched=0}
if(_self.density==1.6){let pos=_self.getPosition();let speed=_self.id=="Box2dModel2"?0.5:Math.abs(3*Math.sin(xAngle*Box2dUtils.DEGREE_TO_RADIAN));let dy=30*Math.sin(yAngle*Box2dUtils.DEGREE_TO_RADIAN);if(fixDirection){let nextPos=pos.x-3;if(nextPos<-width/2)_self.setPosition(new Point(WIDTH+width/2,posY));else _self.setPosition(new Point(nextPos,posY))}else{let nextPos=direction==1?pos.x-speed:pos.x+speed;if(direction==1&&nextPos<-width)if(Math.random()>0.5){_self.setPosition(new Point(nextPos,posY+dy));direction=-1}else _self.setPosition(new Point(WIDTH+width,posY+dy));else if(direction==-1&&nextPos>WIDTH+width)if(Math.random()>0.5){_self.setPosition(new Point(nextPos,posY+dy));direction=1}else _self.setPosition(new Point(-width,posY+dy));else _self.setPosition(new Point(nextPos,posY+dy));xAngle+=Math.random();yAngle++}}
context.save();let pos=_self.getPosition();context.translate(pos.x,pos.y);context.rotate(_self.getAngle());if(!fixDirection)context.scale(direction,1);context.drawImage(view,-width/2,-height/2);context.restore()};_self.destroy=function(){world.DestroyBody(_self.body);delete timer[_self.id]};if(bodies.indexOf(_self)==-1){bodies.push(_self);bc.AddBody(_self.body)}}}();inherit(Box2dModel,Actor);let Point=function(){let ctor=function(x,y){let _self=this;x=x==null?0:x;y=y==null?0:y;_self.x=x;_self.y=y};ctor.distance=function(pt1,pt2){let dx=pt2.x-pt1.x;let dy=pt2.y-pt1.y;return Math.sqrt(dx*dx+dy*dy)};return ctor}();let ResourceEvent=function(){let ctor=function(){};ctor.PROGRESS="progress";ctor.COMPLETED="completed";return ctor}();let ResourceTool=function(){return function(){let _self=this;let _loaded=0;let _resource=null;_self.content={};let _imagePath=imagePath;_self.load=function(resource){if(resource!=null)_resource=resource;if(_loaded>_resource.length-1)$(_self).triggerHandler(ResourceEvent.COMPLETED);else{let str=_resource[_loaded];let loader=_self;let image=new Image;$(image).bind("load",function(e){$(image).unbind("load",arguments.callee);let src=str.substring(str.lastIndexOf("/")+1);loader.content[src.substring(0,src.indexOf("."))]=image;_loaded++;$(_self).triggerHandler(ResourceEvent.PROGRESS,[_loaded/_resource.length]);loader.load()});image.src=_imagePath+_resource[_loaded]}}}}();let Box2dUtils=function(){let ctor=function(){};ctor.parseB2Vec2=function(x,y){return new b2Vec2(x/RATIO,y/RATIO)};ctor.parsePoint=function(vec){return new Point(vec.x*RATIO,vec.y*RATIO)};ctor.RADIAN_TO_DEGREE=180/Math.PI;ctor.DEGREE_TO_RADIAN=Math.PI/180;ctor.generateB2FixtureDef=function(density,friction,restitution){let fixtureDef=new b2FixtureDef;fixtureDef.density=density;fixtureDef.friction=friction;fixtureDef.restitution=restitution;return fixtureDef};ctor.generateCircleB2FixtureDef=function(radius,density,friction,restitution){let fixtureDef=this.generateB2FixtureDef(density,friction,restitution);fixtureDef.shape=new b2CircleShape(radius/RATIO);return fixtureDef};ctor.generatePolygonB2FixtureDef=function(points,density,friction,restitution){let fixtureDef=this.generateB2FixtureDef(density,friction,restitution);let polygonShape=new b2PolygonShape;let vertices=[];for(let i in points)vertices.push(this.parseB2Vec2(points[i].x,points[i].y));polygonShape.SetAsVector(vertices);fixtureDef.shape=polygonShape;return fixtureDef};ctor.generateRectangleB2FixtureDef=function(width,height,density,friction,restitution){let points=[];points.push(new Point(-1*width*0.5,-1*height*0.5));points.push(new Point(width*0.5,-1*height*0.5));points.push(new Point(width*0.5,height*0.5));points.push(new Point(-1*width*0.5,height*0.5));return this.generatePolygonB2FixtureDef(points,density,friction,restitution)};return ctor}();let DENSITY=0.75;let FRICTION=1.14;let MOUSE_PULL=0.09;let AOE=200;let DETAIL;let particles;let ms={x:0,y:0};let mp={x:0,y:0};let initWave=function(){DETAIL=Math.round(WIDTH/10);particles=[];for(let i=0;i<DETAIL+1;i++)particles.push({x:WIDTH/(DETAIL-4)*(i-2),y:waterLevel,original:{x:0,y:waterLevel},velocity:{x:0,y:Math.random()*3},force:{x:0,y:0},mass:10})};let updateWave=function(){let gradientFill=context.createLinearGradient(WIDTH*0.5,waterLevel,WIDTH*0.5,HEIGHT);gradientFill.addColorStop(0,"rgba(127, 204, 227, 0.7)");gradientFill.addColorStop(0.75,"rgba(0, 84, 153, 0.6)");gradientFill.addColorStop(1,"rgba(0, 38, 101, 0.5)");context.fillStyle=gradientFill;context.beginPath();context.moveTo(particles[0].x,particles[0].y);let len=particles.length;let current,previous,next;for(let i=0;i<len;i++){current=particles[i];previous=particles[i-1];next=particles[i+
1];if(previous&&next){let forceY=0;forceY+=-DENSITY*(previous.y-current.y);forceY+=DENSITY*(current.y-next.y);forceY+=DENSITY/15*(current.y-current.original.y);current.velocity.y+=-(forceY/current.mass)+current.force.y;current.velocity.y/=FRICTION;current.force.y/=FRICTION;current.y+=current.velocity.y;let distance=Point.distance(mp,current);if(distance<AOE){let distance=Point.distance(mp,{x:current.original.x,y:current.original.y});ms.x=ms.x*0.98;ms.y=ms.y*0.98;current.force.y+=MOUSE_PULL*(1-distance/AOE)*ms.y}
context.quadraticCurveTo(previous.x,previous.y,previous.x+(current.x-previous.x)/2,previous.y+(current.y-previous.y)/2)}}
context.lineTo(particles[particles.length-1].x,particles[particles.length-1].y);context.lineTo(WIDTH,HEIGHT);context.lineTo(0,HEIGHT);context.lineTo(particles[0].x,particles[0].y);context.fill()};let Twitch=function(x,forceRange){if(ms.x<6||ms.y<6){let particle=particles[Math.round(x/WIDTH*particles.length)];if(particle)particle.force.y+=Math.random()*(forceRange/2)}};let drawBitmap=function(data,x,y,r,s){context.save();context.translate(x+data.width/2,y+data.height/2);context.rotate(r);context.scale(s,s);context.drawImage(data,-data.width/2,-data.height/2);context.restore()};